<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
  </head>
  <body data-cache-scope="marc">
    <div class="container">
      <div class="language-toggle" role="group" aria-label="Language selector">
        <span class="language-toggle-label" data-i18n="language.label">Language:</span>
        <button type="button" class="language-toggle-button" data-lang="en">
          <span data-i18n="language.english">English</span>
        </button>
        <button type="button" class="language-toggle-button" data-lang="lv">
          <span data-i18n="language.latvian">Latviešu</span>
        </button>
      </div>
      <h1 data-i18n="marc.title_main">Batch Processor 📚 → 📄</h1>
      <h2 data-i18n="marc.title_sub">Converter of Images into MARC Text</h2>
      <p data-i18n="marc.subtitle">Batch processing tool for converting images to MARC text</p>
      <form method="post" enctype="multipart/form-data">
        <label data-i18n="marc.api_key_label">API Key:</label>
        <input type="text" name="api_key" required>

        <label data-i18n="marc.system_prompt_label">System Prompt:</label>
        <button type="button" id="load-marc-prompt" class="secondary-button">
          <span data-i18n="marc.load_prompt_button">Load from static/prompts/marc.txt</span>
        </button>
        <textarea name="system_prompt" rows="4" cols="50"></textarea>

        <label data-i18n="marc.username_label">Username:</label>
        <input
          type="text"
          name="username"
          placeholder="e.g. rek_user"
          data-i18n-placeholder="marc.username_placeholder"
        >

        <label data-i18n="marc.custom_footer_label">Custom Footer:</label>
        <textarea
          name="customFooter"
          class="compact-textarea"
          rows="3"
          placeholder="Optional text appended after each successful LLM response"
          data-i18n-placeholder="marc.custom_footer_placeholder"
        ></textarea>

        <label data-i18n="marc.choose_model_label">Choose Model:</label>
        {% include "_model_dropdown.html" %}

        <label data-i18n="marc.custom_model_label">Or enter custom model ID:</label>
        <input
          type="text"
          name="model_custom"
          placeholder="e.g. openai/gpt-4.1-mini"
          data-i18n-placeholder="marc.custom_model_placeholder"
        >

        <label data-i18n="marc.upload_zip_label">Upload ZIP (optional if choosing a folder below):</label>
        <input type="file" name="zipfile" required>
        <input type="hidden" name="existing_folder" value="">

        <div class="existing-zips">
          <p class="existing-zips-title">
            <span data-i18n="marc.choose_subfolder_prefix">Or choose a subfolder from</span>
            <code>{{ existing_folders_label }}</code>:
          </p>
          {% if existing_folders %}
            <ul class="existing-zips-list">
              {% for folder_item in existing_folders %}
                <li>
                  <button
                    type="button"
                    class="existing-zip-button"
                    data-existing-folder="{{ folder_item.name }}"
                  >
                    <span class="existing-zip-name">{{ folder_item.name }}/</span>
                    <span
                      class="existing-zip-meta"
                      data-item-count="{{ folder_item.items_label | replace(' items', '') | replace(' item', '') }}"
                      data-modified-at="{{ folder_item.modified_at }}"
                    >{{ folder_item.items_label }} | {{ folder_item.modified_at }}</span>
                  </button>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="existing-zips-empty">
              <span data-i18n="marc.no_folders_prefix">No folders found in</span>
              <code>{{ existing_folders_label }}</code>.
            </p>
          {% endif %}
          <p id="existing-folder-status" class="existing-zip-status" aria-live="polite"></p>
        </div>

        <label>
          <input type="checkbox" name="include_inputs" value="true">
          <span data-i18n="marc.include_inputs">Include inputs in output zip</span>
        </label>
        <label>
          <input type="checkbox" name="separate_outputs" value="true" checked>
          <span data-i18n="marc.separate_outputs">Separate text files in output zip</span>
        </label>
        <label>
          <input type="checkbox" name="include_metadata" value="true">
          <span data-i18n="marc.include_metadata">Include metadata.json</span>
        </label>
        <label>
          <input type="checkbox" name="save_concat_results" value="true" checked>
          <span data-i18n="marc.save_concat_prefix">Save concatenated results to</span>
          <code>/mnt/mi_rek/results</code>
        </label>
        {% if error %}
          <p class="error">{{ error }}</p>
        {% endif %}

        <input type="submit" value="Submit Job" data-i18n-value="marc.submit_job">
      </form>
      <p><a href="{{ url_for('jobs_archive') }}" data-i18n="marc.jobs_archive">Jobs archive</a></p>
    </div>
    <script>
      (() => {
        const loadPromptButton = document.getElementById("load-marc-prompt");
        const promptField = document.querySelector('textarea[name="system_prompt"]');
        if (!loadPromptButton || !promptField) {
          return;
        }

        const pathname = window.location.pathname || "";
        const trimmedPath = pathname.replace(/\/+$/, "");
        const appBase = trimmedPath.endsWith("/marc")
          ? trimmedPath.slice(0, -"/marc".length)
          : trimmedPath;
        const promptUrl = `${appBase || ""}/static/prompts/marc.txt`;
        loadPromptButton.addEventListener("click", async () => {
          loadPromptButton.disabled = true;
          try {
            const response = await fetch(promptUrl, { cache: "no-store" });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            promptField.value = await response.text();
            promptField.dispatchEvent(new Event("input", { bubbles: true }));
          } catch (error) {
            console.error("Failed to load MARC system prompt:", error);
            const i18n = window.formCacheI18n;
            const message =
              i18n && typeof i18n.t === "function"
                ? i18n.t("marc.prompt_load_error")
                : "Failed to load prompt from static/prompts/marc.txt.";
            alert(message);
          } finally {
            loadPromptButton.disabled = false;
          }
        });
      })();
    </script>
    <script src="{{ url_for('static', filename='scripts/marc-i18n.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/form-cache.js') }}"></script>
    <script>
      (() => {
        const usernameField = document.querySelector('input[name="username"]');
        const customFooterField = document.querySelector('textarea[name="customFooter"]');
        if (!customFooterField) {
          return;
        }

        const pathname = window.location.pathname || "";
        const trimmedPath = pathname.replace(/\/+$/, "");
        const appBase = trimmedPath.endsWith("/marc")
          ? trimmedPath.slice(0, -"/marc".length)
          : trimmedPath;
        const footerTemplateUrl = `${appBase || ""}/static/config/marc_postfix.txt`;

        const now = new Date();
        const yyyy = String(now.getFullYear());
        const pad2 = (value) => String(value).padStart(2, "0");
        const yyyymmdd = `${yyyy}${pad2(now.getMonth() + 1)}${pad2(now.getDate())}`;
        let templateText = "";
        let lastAutoValue = null;

        const renderFooter = () => {
          const username = usernameField ? usernameField.value.trim() : "";
          return templateText
            .replaceAll("{YYYY}", yyyy)
            .replaceAll("{YYYYMMDD}", yyyymmdd)
            .replaceAll("{username}", username);
        };

        const applyAutoFooter = () => {
          if (!templateText) {
            return;
          }

          const currentValue = customFooterField.value;
          const isEmpty = currentValue.trim() === "";
          const isCurrentAutoValue = lastAutoValue !== null && currentValue === lastAutoValue;
          if (!isEmpty && !isCurrentAutoValue) {
            return;
          }

          const generated = renderFooter();
          customFooterField.value = generated;
          lastAutoValue = generated;
          customFooterField.dispatchEvent(new Event("input", { bubbles: true }));
        };

        if (usernameField) {
          usernameField.addEventListener("input", () => {
            applyAutoFooter();
          });
        }

        fetch(footerTemplateUrl, { cache: "no-store" })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.text();
          })
          .then((text) => {
            templateText = text;
            const currentValue = customFooterField.value;
            if (currentValue !== "" && currentValue === renderFooter()) {
              lastAutoValue = currentValue;
            }
            applyAutoFooter();
          })
          .catch((error) => {
            console.error("Failed to load MARC footer template:", error);
          });
      })();
    </script>
  </body>
</html>
