<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
  </head>
  <body data-cache-scope="marc">
    <div class="container">
      <h1>Batch Processor 📚 → 📄</h1>
      <h2>Converter of Images into MARC Text</h2>
      <p>Masveida apstrādes rīks - attēlu pārveidotājs MARC tekstā</p>
      <form method="post" enctype="multipart/form-data">
        <label>API Key:</label>
        <input type="text" name="api_key" required>

        <label>System Prompt:</label>
        <button type="button" id="load-marc-prompt" class="secondary-button">
          Load from static/prompts/marc.txt
        </button>
        <textarea name="system_prompt" rows="4" cols="50"></textarea>

        <label>Choose Model:</label>
        {% include "_model_dropdown.html" %}

        <label>Or enter custom model ID:</label>
        <input type="text" name="model_custom" placeholder="e.g. openai/gpt-4.1-mini">

        <label>Upload ZIP (optional if choosing a folder below):</label>
        <input type="file" name="zipfile" required>
        <input type="hidden" name="existing_folder" value="">

        <div class="existing-zips">
          <p class="existing-zips-title">Or choose a subfolder from <code>{{ existing_folders_label }}</code>:</p>
          {% if existing_folders %}
            <ul class="existing-zips-list">
              {% for folder_item in existing_folders %}
                <li>
                  <button
                    type="button"
                    class="existing-zip-button"
                    data-existing-folder="{{ folder_item.name }}"
                  >
                    <span class="existing-zip-name">{{ folder_item.name }}/</span>
                    <span class="existing-zip-meta">{{ folder_item.items_label }} | {{ folder_item.modified_at }}</span>
                  </button>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="existing-zips-empty">No folders found in <code>{{ existing_folders_label }}</code>.</p>
          {% endif %}
          <p id="existing-folder-status" class="existing-zip-status" aria-live="polite"></p>
        </div>

        <label>
          <input type="checkbox" name="include_inputs" value="true">
          Include inputs in output zip
        </label>
        <label>
          <input type="checkbox" name="separate_outputs" value="true" checked>
          Separate text files in output zip
        </label>
        <label>
          <input type="checkbox" name="include_metadata" value="true">
          Include metadata.json
        </label>
        <label>
          <input type="checkbox" name="save_concat_results" value="true" checked>
          Save concatenated results to <code>/mnt/mi_rek/results</code>
        </label>
        {% if error %}
          <p class="error">{{ error }}</p>
        {% endif %}

        <input type="submit" value="Submit Job">
      </form>
      <p><a href="{{ url_for('jobs_archive') }}">Jobs archive</a></p>
    </div>
    <script>
      (() => {
        const loadPromptButton = document.getElementById("load-marc-prompt");
        const promptField = document.querySelector('textarea[name="system_prompt"]');
        if (!loadPromptButton || !promptField) {
          return;
        }

        const pathname = window.location.pathname || "";
        const trimmedPath = pathname.replace(/\/+$/, "");
        const appBase = trimmedPath.endsWith("/marc")
          ? trimmedPath.slice(0, -"/marc".length)
          : trimmedPath;
        const promptUrl = `${appBase || ""}/static/prompts/marc.txt`;
        loadPromptButton.addEventListener("click", async () => {
          loadPromptButton.disabled = true;
          try {
            const response = await fetch(promptUrl, { cache: "no-store" });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            promptField.value = await response.text();
            promptField.dispatchEvent(new Event("input", { bubbles: true }));
          } catch (error) {
            console.error("Failed to load MARC system prompt:", error);
            alert("Failed to load prompt from static/prompts/marc.txt.");
          } finally {
            loadPromptButton.disabled = false;
          }
        });
      })();
    </script>
    <script src="{{ url_for('static', filename='scripts/form-cache.js') }}"></script>
  </body>
</html>
