<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <style>
      .progress-container {
        width: 100%;
        background-color: #eee;
        border-radius: 6px;
        margin: 20px 0;
      }
      .progress-bar {
        width: 0%;
        height: 24px;
        background-color: #0077cc; /* blue by default */
        border-radius: 6px;
        text-align: center;
        color: white;
        line-height: 24px;
        font-size: 12px;
        transition: width 0.5s ease;
      }
      .progress-bar.finished {
        background-color: #28a745; /* green when done */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Job {{ job_id }}</h1>
      <p><strong>Status:</strong> {{ status }}</p>
      <p><strong>Model:</strong> {{ model }}</p>
      <p><strong>Submitted at:</strong> {{ submitted_at }}</p>
      {% if completed_at %}
        <p><strong>Completed at:</strong> {{ completed_at }}</p>
      {% endif %}
      {% if elapsed_time %}
        <p><strong>Elapsed time:</strong> {{ elapsed_time }}</p>
      {% endif %}

      <!-- Progress Bar -->
      <div class="progress-container">
        <div id="progress-bar" class="progress-bar">0%</div>
      </div>
      <p id="progress-text"></p>

      {% if result_url and zip_filename %}
        <p><a id="results-download-link" href="{{ result_url }}">Download results ({{ zip_filename }})</a></p>
      {% endif %}

      <p><a href="/">Back to home</a></p>
    </div>
    <footer>
      <p style="font-size: 0.8em; color: #666; text-align: center; margin-top: 40px;">
        &copy; 2025 LNB OpenRouter Batch Processor
      </p>
    </footer>
    <!-- Progress update script -->

    <script>
       let intervalId = null;
      function updateProgress() {
        //relative URL to avoid CORS issues
        fetch("../progress/{{ job_id }}")
          .then(r => r.json())
          .then(data => {
            if (data.total > 0) {
              let percent = Math.floor((data.processed / data.total) * 100);
              let bar = document.getElementById("progress-bar");
              bar.style.width = percent + "%";
              bar.textContent = percent + "%";
              document.getElementById("progress-text").textContent =
                data.processed + " / " + data.total + " files";

              if (data.processed === data.total) {
                jobFinished = true;
                bar.classList.add("finished"); // turn green
                // Stop polling once finished 
                if (intervalId) {
                  console.log("Stopping progress polling.", intervalId);
                  clearInterval(intervalId);
                }
                //check if download link is present, if not, reload to show it
                if (!document.getElementById("results-download-link")) {
                  console.log("Job finished, reloading to show download link.");
                  location.reload();
                }

              }
            }
          })
          .catch(err => console.log("Progress fetch error:", err));
      }
      intervalId = setInterval(updateProgress, 3000);
      updateProgress();
    </script>
  </body>
</html>
